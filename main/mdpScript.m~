%created by Trent Dillon on July 30th 2018
%code simulates Markov Decision Process algorithm of WAMP system
%multiple or one-off simulations are enabled

clearvars -except FM

%% to do

%old goals
%1 - have meta data for multiple runs
%3 - discount factor runs
%3 - adapt visMultSims so it can handle multiple mult sims
%1 - n sensitivity analysis
%1 - add error visualization (visSimError and visMultError(?))
%5 - add uncertainty parameter (rubust MDP)
%5 - get more data
%5 - try smoothing over outages (reconstruct Hs and Tp)
%5 - maximum/minimum charge/discharge rates into battery model

%new things I have noticed...
% - add capacity fading to simulateWAMP

%% simulate OO-WEC

%load forecast matrix
if ~exist('FM','var')
    load('WETSForecastMatrix')
    FM = WETSForecastMatrix.FM_subset;
    clear WETSForecastMatrix
end
mdpInputs

tTot = tic;
if sim.multiple %sensitivity analysis
    %assemble array
    m = length(sim.tuning_array(:,1));
    n = length(sim.tuning_array(:,2));
    [S1,S2] = meshgrid(sim.tuning_array(:,1),sim.tuning_array(:,2));
    S1 = reshape(S1,[m*n 1]);
    S2 = reshape(S2,[m*n 1]);
    %set number of cores
    if isempty(gcp('nocreate')) && sim.hpc && ~sim.brpar 
        cores = feature('numcores'); %find number of cores
        if cores > sim.corelim %only start if using HPC
            parpool(cores);
        end
    end
    %preallocate
    clear multStruct
    multStruct(m*n) = struct();
    disp(['Beginning sensitivity analysis of ' num2str(m*n) ...
        ' combinations,'])
    DT = table(S1,S2,'VariableNames', ...
        {sim.tuned_parameter{1},sim.tuned_parameter{2}});
    disp(DT)
    if ~sim.expar
        sim.mw = 0;
    end
    parfor (i = 1:m*n,sim.mw)
        output = simulateWAMP(FM,amp,frc,mdp,sim,wec,tTot,i);
        multStruct(i).amp = amp;
        multStruct(i).frc = frc;
        multStruct(i).mdp = mdp;
        multStruct(i).output = output;
        multStruct(i).sim = sim;
        multStruct(i).wec = wec;
    end
    multStruct = reshape
    disp([num2str(sim.s) ' simulations complete after ' ...
        num2str(round(toc(tTot)/60,2)) ' minutes. '])
else %single simulation
    sim.expar = false;
    output = simulateWAMP(FM,amp,frc,mdp,sim,wec,tTot); %run simulation
    simStruct.output = output;
    simStruct.amp = amp;
    simStruct.FM = FM;
    simStruct.frc = frc; 
    simStruct.mdp = mdp; 
    simStruct.sim = sim; 
    simStruct.wec = wec; 
end

clear i tTot